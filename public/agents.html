<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Manager</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --border: #374151;
      --muted: #9ca3af;
      --accent: #3b82f6;
    }
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: var(--bg); color: var(--text); 
      margin: 0; padding: 32px; line-height: 1.6;
    }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px; }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    .panel { 
      border: 1px solid var(--border); border-radius: 12px; 
      background: var(--panel); padding: 24px; 
    }
    h1, h3 { margin-top: 0; }
    h3 { font-size: 1.2rem; color: var(--text); margin-bottom: 16px; }
    .field { margin-bottom: 12px; }
    .row { display: flex; gap: 12px; margin-bottom: 12px; }
    .row .field { flex: 1; }
    label { display: block; font-size: 0.875rem; margin-bottom: 4px; color: var(--muted); }
    input, select, textarea { 
      width: 100%; border: 1px solid var(--border); border-radius: 6px; 
      background: var(--bg); color: var(--text); padding: 8px 12px;
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus { 
      outline: 2px solid var(--accent); outline-offset: 1px; 
    }
    button { 
      background: var(--accent); color: white; border: none; border-radius: 6px; 
      padding: 10px 16px; font-size: 14px; cursor: pointer; margin-right: 8px; margin-bottom: 8px;
    }
    button:hover { opacity: 0.9; }
    button.secondary { background: #6b7280; }
    .list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 8px; }
    .card { 
      border: 1px solid var(--border); border-radius: 6px; padding: 12px; 
      margin-bottom: 8px; background: var(--bg);
      display: flex; justify-content: space-between; align-items: center;
    }
    .card button { font-size: 12px; padding: 4px 8px; }
    .muted { color: var(--muted); font-size: 12px; }
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .tab-button { 
      background: none; border: none; color: var(--muted); 
      padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent;
      margin-right: 0; margin-bottom: 0;
    }
    .tab-button.active { color: var(--accent); border-bottom-color: var(--accent); }
    .agent-form { margin-bottom: 20px; }
    .save-agent-btn { background: #10b981; }
    .save-agent-btn:hover { background: #059669; }
    .logs { 
      background: var(--bg); border: 1px solid var(--border); border-radius: 6px; 
      padding: 12px; font-family: monospace; font-size: 12px; white-space: pre-wrap;
      max-height: 200px; overflow-y: auto; margin-top: 16px;
    }
    textarea { min-height: 60px; }
    .badge { display: inline-flex; padding: 4px 8px; border-radius: 8px; border: 1px solid var(--border); background: #111827; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <h1>Agent Manager</h1>
  <div class="grid">
    <section class="panel">
      <h3>Create New Agent</h3>
      <div id="account-warning" class="muted" style="color:#f87171; margin-bottom:8px;"></div>
      
      <!-- Agent Type Selection Tabs -->
      <div class="tabs">
        <button class="tab-button active" onclick="switchAgentType('perplexity')">Perplexity Wrapper Agent</button>
        <button class="tab-button" onclick="switchAgentType('gemini')">Gemini Wrapper Agent</button>
      </div>
      
      <!-- Perplexity Agent Form -->
      <div id="perplexity-form" class="agent-form">
        <div class="field">
          <label for="perplexity-agent-name">Name</label>
          <input id="perplexity-agent-name" placeholder="Agent name" />
        </div>
        <div class="row">
          <div class="field">
            <label for="perplexity-agent-account">Account</label>
            <select id="perplexity-agent-account"></select>
          </div>
          <div class="field">
            <label for="perplexity-agent-collection">Space (collection_uuid)</label>
            <select id="perplexity-agent-collection">
              <option value="">(none)</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="perplexity-agent-mode">Mode</label>
            <select id="perplexity-agent-mode">
              <option value="">(default)</option>
              <option value="auto">auto</option>
              <option value="writing">writing</option>
              <option value="coding">coding</option>
              <option value="research">research</option>
            </select>
          </div>
          <div class="field">
            <label for="perplexity-agent-sources">Sources</label>
            <input id="perplexity-agent-sources" placeholder="web,scholar,social" />
          </div>
          <div class="field">
            <label for="perplexity-agent-language">Language</label>
            <input id="perplexity-agent-language" placeholder="en-US" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="perplexity-agent-model">Model</label>
            <input id="perplexity-agent-model" placeholder="optional" />
          </div>
          <div class="field">
            <label class="muted">
              <input type="checkbox" id="perplexity-agent-answer-only" checked />
              Answer only
            </label>
          </div>
          <div class="field">
            <label class="muted">
              <input type="checkbox" id="perplexity-agent-incognito" />
              Incognito
            </label>
          </div>
        </div>
        <div class="row">
          <button id="save-perplexity-agent" class="save-agent-btn">Save Perplexity Agent</button>
        </div>
      </div>
      
      <!-- Gemini Agent Form -->
      <div id="gemini-form" class="agent-form" style="display: none;">
        <div class="field">
          <label for="gemini-agent-name">Name</label>
          <input id="gemini-agent-name" placeholder="Agent name" />
        </div>
        <div class="row">
          <div class="field">
            <label for="gemini-agent-account">Account</label>
            <select id="gemini-agent-account"></select>
          </div>
          <div class="field">
            <label for="gemini-agent-model">Model</label>
            <select id="gemini-agent-model">
              <option value="">(default: gemini-2.5-flash)</option>
              <option value="gemini-2.5-flash">gemini-2.5-flash</option>
              <option value="gemini-3.0-pro">gemini-3.0-pro</option>
              <option value="gemini-1.5-flash">gemini-1.5-flash</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="gemini-agent-gems">Custom GEMS (gem://URL)</label>
            <input id="gemini-agent-gems" placeholder="gem://61e010447d16 SolarExpert" />
          </div>
        </div>
        <div class="row">
          <button id="save-gemini-agent" class="save-agent-btn">Save Gemini Agent</button>
        </div>
      </div>
      
      <!-- Common controls -->
      <div class="row">
        <button id="refresh-accounts" class="secondary">Refresh Accounts/Spaces</button>
      </div>
      <div class="logs" id="logs"></div>
    </section>
    <section class="panel">
      <h3>Wrapper Info</h3>
      <div class="row">
        <div class="field">
          <label>Accounts</label>
          <div class="list" id="account-list"></div>
        </div>
        <div class="field">
          <label>Spaces</label>
          <div class="list" id="space-list"></div>
        </div>
      </div>
    </section>
  </div>
  <section class="panel" style="margin-top:16px;">
    <h3>Agents</h3>
    <div class="list" id="agents"></div>
  </section>

  <script>
    // Agent type switching
    function switchAgentType(type) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Show/hide forms
      document.getElementById('perplexity-form').style.display = type === 'perplexity' ? 'block' : 'none';
      document.getElementById('gemini-form').style.display = type === 'gemini' ? 'block' : 'none';
      
      // Update account lists
      renderAccounts();
    }

    // Existing JavaScript (simplified)
    const accountList = document.getElementById("account-list");
    const spaceList = document.getElementById("space-list");
    const agentsContainer = document.getElementById("agents");
    const logs = document.getElementById("logs");

    let accounts = [];
    let spaces = [];
    let agents = [];
    let defaultAccount = "";
    let wrapperStatus = "unknown";

    function log(obj) {
      logs.textContent = JSON.stringify(obj, null, 2);
    }

    function renderAccounts() {
      accountList.innerHTML = "";
      const warning = document.getElementById("account-warning");
      
      if (!accounts.length && !defaultAccount) {
        warning.textContent = "Set DEFAULT_ACCOUNT_NAME in env or pick an account via Refresh.";
      } else {
        warning.textContent = "";
      }
      
      if (!accounts.length) {
        accountList.innerHTML = "<div class='muted'>No accounts (use manual entry)</div>";
        return;
      }
      
      accounts.forEach((a) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<strong>${a.name || a.account_name || "Account"}</strong><span class="muted">${a.account_name || a.name || ""}</span>`;
        const btn = document.createElement("button");
        btn.className = "secondary";
        btn.textContent = "Test";
        btn.onclick = () => testAccount(a.account_name || a.name);
        div.appendChild(btn);
        accountList.appendChild(div);
      });
      
      // Update both account dropdowns
      const perplexitySelect = document.getElementById("perplexity-agent-account");
      const geminiSelect = document.getElementById("gemini-agent-account");
      
      [perplexitySelect, geminiSelect].forEach(select => {
        if (!select) return;
        select.innerHTML = "<option value=''>Type account manually below</option>" +
          accounts.map(a => `<option value="${a.account_name || a.name}">${a.name || a.account_name}</option>`).join("");
      });
    }

    function renderSpaces() {
      spaceList.innerHTML = "";
      const perplexitySelect = document.getElementById("perplexity-agent-collection");
      if (perplexitySelect) {
        perplexitySelect.innerHTML = "<option value=''>None</option>";
      }
      
      if (!spaces.length) {
        spaceList.innerHTML = "<div class='muted'>No spaces</div>";
        return;
      }
      
      spaces.forEach((s) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<strong>${s.name || s.title || "Space"}</strong><span class="muted">${s.uuid || s.id || s.slug || ""}</span>`;
        spaceList.appendChild(div);
        
        if (s.uuid || s.id && perplexitySelect) {
          const id = s.uuid || s.id;
          perplexitySelect.innerHTML += `<option value="${id}">${s.name || s.title || id}</option>`;
        }
      });
    }

    function renderAgents() {
      agentsContainer.innerHTML = "";
      if (!agents.length) {
        agentsContainer.innerHTML = "<div class='muted'>No agents</div>";
        return;
      }
      agents.forEach((a) => {
        const div = document.createElement("div");
        div.className = "card";
        const typeBadge = a.agentType === "gemini" 
          ? '<span class="badge" style="background: #8b5cf6;">Gemini</span>' 
          : '<span class="badge" style="background: #3b82f6;">Perplexity</span>';
        div.innerHTML = `${typeBadge}<strong>${a.name}</strong><span class="muted">${a.accountName}</span>`;
        const testBtn = document.createElement("button");
        testBtn.className = "secondary";
        testBtn.textContent = "Test";
        testBtn.onclick = () => testAgent(a.id);
        div.appendChild(testBtn);
        const delBtn = document.createElement("button");
        delBtn.className = "secondary";
        delBtn.textContent = "Delete";
        delBtn.style.background = "#dc2626";
        delBtn.onclick = () => deleteAgent(a.id);
        div.appendChild(delBtn);
        agentsContainer.appendChild(div);
      });
    }

    async function fetchAccounts() {
      const res = await fetch("/api/accounts");
      const data = await res.json();
      return data.accounts || [];
    }

    async function fetchSpaces() {
      const res = await fetch("/api/spaces");
      const data = await res.json();
      return data.spaces || [];
    }

    async function fetchAgents() {
      const res = await fetch("/api/agents");
      const data = await res.json();
      return data.agents || [];
    }

    async function testAccount(accountName) {
      log({ testing: accountName });
      try {
        const res = await fetch(`/api/accounts/${encodeURIComponent(accountName)}/test`);
        const data = await res.json();
        log(data);
      } catch (err) {
        log({ error: err.message });
      }
    }

    async function testAgent(agentId) {
      log({ testingAgent: agentId });
      try {
        const res = await fetch(`/api/agents/${agentId}/test`);
        const data = await res.json();
        log(data);
      } catch (err) {
        log({ error: err.message });
      }
    }

    async function deleteAgent(agentId) {
      if (!confirm("Delete this agent?")) return;
      log({ deleting: agentId });
      try {
        const res = await fetch(`/api/agents/${agentId}`, { method: "DELETE" });
        const data = await res.json();
        log(data);
        loadAgents();
      } catch (err) {
        log({ error: err.message });
      }
    }

    // Save Perplexity Agent
    async function savePerplexityAgent() {
      const payload = {
        name: document.getElementById("perplexity-agent-name").value,
        agentType: "perplexity",
        accountName: document.getElementById("perplexity-agent-account").value,
        collectionUuid: document.getElementById("perplexity-agent-collection").value || null,
        model: document.getElementById("perplexity-agent-model").value || null,
        mode: document.getElementById("perplexity-agent-mode").value || null,
        sources: document.getElementById("perplexity-agent-sources").value || null,
        language: document.getElementById("perplexity-agent-language").value || null,
        answerOnly: document.getElementById("perplexity-agent-answer-only").checked,
        incognito: document.getElementById("perplexity-agent-incognito").checked,
      };
      log({ saving: payload });
      try {
        const res = await fetch("/api/agents", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (res.ok) {
          log({ success: data });
          loadAgents();
          // Clear form
          document.getElementById("perplexity-agent-name").value = "";
        } else {
          log({ error: data });
        }
      } catch (err) {
        log({ error: err.message });
      }
    }

    // Save Gemini Agent
    async function saveGeminiAgent() {
      const payload = {
        name: document.getElementById("gemini-agent-name").value,
        agentType: "gemini",
        accountName: document.getElementById("gemini-agent-account").value || "primary",
        model: document.getElementById("gemini-agent-model").value || null,
        systemPrompt: document.getElementById("gemini-agent-gems").value || null,
        // Don't include Perplexity-specific fields
      };
      log({ saving: payload });
      try {
        const res = await fetch("/api/agents", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (res.ok) {
          log({ success: data });
          loadAgents();
          // Clear form
          document.getElementById("gemini-agent-name").value = "";
          document.getElementById("gemini-agent-gems").value = "";
        } else {
          log({ error: data });
        }
      } catch (err) {
        log({ error: err.message });
      }
    }

    async function loadAccounts() {
      accounts = await fetchAccounts();
      renderAccounts();
    }

    async function loadSpaces() {
      spaces = await fetchSpaces();
      renderSpaces();
    }

    async function loadAgents() {
      agents = await fetchAgents();
      renderAgents();
    }

    async function refresh() {
      try {
        await Promise.all([loadAccounts(), loadSpaces(), loadAgents()]);
        log({ refreshed: true });
      } catch (err) {
        log({ error: err.message });
      }
    }

    // Event listeners
    document.getElementById("save-perplexity-agent").onclick = savePerplexityAgent;
    document.getElementById("save-gemini-agent").onclick = saveGeminiAgent;
    document.getElementById("refresh-accounts").onclick = refresh;

    // Initialize
    refresh();
  </script>
</body>
</html>
