<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Chat Data</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --text: #f1f5f9;
      --border: #334155;
      --accent: #38bdf8;
      --muted: #94a3b8;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
    }
    h1 { margin-top: 0; }
    .container {
      display: flex;
      flex: 1;
      gap: 20px;
      overflow: hidden;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
    }
    .sidebar {
      width: 300px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      font-weight: bold;
      background: rgba(0,0,0,0.2);
    }
    .thread-list {
      flex: 1;
      overflow-y: auto;
    }
    .thread-item {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    .thread-item:hover { background: rgba(255,255,255,0.05); }
    .thread-item.active { background: rgba(56, 189, 248, 0.15); border-left: 3px solid var(--accent); }
    .thread-title { font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .thread-meta { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }
    .message.user {
      align-self: flex-end;
      background: #0ea5e9;
      color: white;
      border-bottom-right-radius: 2px;
    }
    .message.bot {
      align-self: flex-start;
      background: var(--panel);
      border: 1px solid var(--border);
      border-bottom-left-radius: 2px;
    }
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
    }
    .refresh-btn {
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .refresh-btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h1>All Chat Data</h1>
    <button class="refresh-btn" onclick="loadThreads()">Refresh Data</button>
  </div>

  <div class="container">
    <div class="sidebar">
      <div class="sidebar-header">
        All Threads <span id="thread-count" style="font-weight:normal; color:var(--muted); font-size:12px;">(0)</span>
      </div>
      <div class="thread-list" id="thread-list">
        <div style="padding:20px; text-align:center; color:var(--muted);">Loading...</div>
      </div>
    </div>
    <div class="main-content">
      <div class="chat-header">
        <div id="active-thread-title">Select a thread</div>
        <div id="active-thread-id" style="font-size:12px; color:var(--muted);"></div>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="empty-state">Select a conversation from the left to view details</div>
      </div>
    </div>
  </div>

  <script>
    async function loadThreads() {
      const listEl = document.getElementById('thread-list');
      listEl.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted);">Loading...</div>';
      
      try {
        const res = await fetch('/api/admin/all-threads');
        const data = await res.json();
        
        document.getElementById('thread-count').textContent = `(${data.threads.length})`;
        listEl.innerHTML = '';
        
        if (data.threads.length === 0) {
          listEl.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted);">No threads found</div>';
          return;
        }

        data.threads.forEach(t => {
          const div = document.createElement('div');
          div.className = 'thread-item';
          div.onclick = () => loadChat(t.thread_uuid, t.title, div);
          div.innerHTML = `
            <div class="thread-title">${t.title || 'Untitled Thread'}</div>
            <div class="thread-meta">
              <span>${new Date(t.updated_at).toLocaleDateString()}</span>
              <span>${t.tester_id.substring(0,8)}...</span>
            </div>
          `;
          listEl.appendChild(div);
        });
      } catch (err) {
        listEl.innerHTML = '<div style="padding:20px; text-align:center; color:red;">Error loading threads</div>';
        console.error(err);
      }
    }

    async function loadChat(threadUuid, title, listElement) {
      // UI Updates
      document.querySelectorAll('.thread-item').forEach(el => el.classList.remove('active'));
      if(listElement) listElement.classList.add('active');
      
      document.getElementById('active-thread-title').textContent = title || 'Untitled Thread';
      document.getElementById('active-thread-id').textContent = threadUuid;
      const msgContainer = document.getElementById('chat-messages');
      msgContainer.innerHTML = '<div class="empty-state">Loading messages...</div>';

      try {
        const res = await fetch(`/api/messages/${threadUuid}`);
        const data = await res.json();
        
        msgContainer.innerHTML = '';
        if (!data.messages || data.messages.length === 0) {
          msgContainer.innerHTML = '<div class="empty-state">No messages in this thread</div>';
          return;
        }

        data.messages.forEach(m => {
          const div = document.createElement('div');
          div.className = `message ${m.role === 'user' ? 'user' : 'bot'}`;
          
          // Simple formatting
          let content = m.content
             .replace(/</g, '&lt;').replace(/>/g, '&gt;')
             .replace(/\n/g, '<br>');
             
          // Bold
          content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          
          div.innerHTML = content;
          
          // Add timestamp if available
          if (m.created_at) {
             const timeDiv = document.createElement('div');
             timeDiv.style.fontSize = '10px';
             timeDiv.style.marginTop = '4px';
             timeDiv.style.opacity = '0.7';
             timeDiv.textContent = new Date(m.created_at).toLocaleTimeString();
             div.appendChild(timeDiv);
          }
          
          msgContainer.appendChild(div);
        });
      } catch (err) {
        msgContainer.innerHTML = '<div class="empty-state" style="color:red">Failed to load messages</div>';
      }
    }

    // Init
    loadThreads();
  </script>
</body>
</html>
