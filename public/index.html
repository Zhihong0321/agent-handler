<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perplexity Agent Playground</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --accent: #38bdf8;
      --muted: #6b7280;
      --border: #1f2937;
      --danger: #ef4444;
      --warning: #eab308;
      --success: #10b981;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #1e293b 0, #0f172a 45%),
                  radial-gradient(circle at 80% 10%, #0ea5e9 0, transparent 35%),
                  radial-gradient(circle at 60% 70%, #10b981 0, transparent 25%),
                  #0f172a;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header h1 { margin: 0; font-size: 20px; letter-spacing: 0.4px; }
    header .tag {
      padding: 4px 10px;
      border-radius: 10px;
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
    }
    main {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      padding: 0 20px 20px;
      flex: 1;
    }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
    }
    .panel {
      background: rgba(17, 24, 39, 0.85);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-right: 6px;
      min-height: 300px;
      max-height: 65vh;
    }
    .bubble {
      padding: 12px 14px;
      border-radius: 12px;
      max-width: 90%;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    .bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0b1222;
      font-weight: 600;
    }
    .bubble.bot {
      align-self: flex-start;
      background: #111827;
      border: 1px solid var(--border);
    }
    form {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    textarea, input, select, button {
      font: inherit;
      color: var(--text);
    }
    textarea {
      flex: 1;
      background: #0b1222;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      min-height: 62px;
      resize: vertical;
    }
    button {
      background: linear-gradient(135deg, #38bdf8, #22d3ee);
      border: none;
      color: #0b1222;
      font-weight: 700;
      padding: 0 18px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
      box-shadow: 0 10px 25px rgba(34, 211, 238, 0.35);
    }
    button:active { transform: translateY(1px); box-shadow: none; }
    button.secondary {
      background: #0b1222;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }
    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
    .field label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; }
    .field input, .field select {
      background: #0b1222;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
    }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    .pill {
      padding: 8px 12px;
      border-radius: 10px;
      background: #0b1222;
      border: 1px dashed var(--border);
      color: var(--muted);
      font-size: 13px;
    }
    .thread-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      max-height: 260px;
      overflow: auto;
      margin-top: 12px;
    }
    .thread-card {
      background: #0b1222;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .thread-card h4 { margin: 0; font-size: 13px; color: var(--text); }
    .thread-card small { color: var(--muted); word-break: break-all; }
    
    /* Modal Styles */
    dialog {
      background: #111827;
      color: var(--text);
      border: 1px solid var(--accent);
      border-radius: 14px;
      padding: 0;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    dialog::backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); }
    .modal-content { padding: 20px; }
    .modal-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; margin: 15px 0; }
    .agent-btn {
      text-align: left;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0b1222;
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .agent-btn:hover { border-color: var(--accent); }
    .agent-btn strong { display: block; }
    .agent-btn small { color: var(--muted); }

    .logs {
      background: #0b1222;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      max-height: 200px;
      overflow: auto;
      font-family: "SFMono-Regular", Consolas, monospace;
      font-size: 12px;
      margin-top: 12px;
    }
    .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .toggle { display: inline-flex; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); }
    .badge {
      display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px;
      border-radius: 10px; background: #0b1222; border: 1px solid var(--border);
      font-size: 12px; color: var(--muted);
    }
    .badge.positive { border-color: rgba(16,185,129,0.5); color: var(--success); }
    .badge.warning { border-color: rgba(234,179,8,0.5); color: var(--warning); }
    .badge.danger { border-color: rgba(239,68,68,0.5); color: var(--danger); }
    
    .agent-selection {
        display: flex; gap: 10px;
        background: #0b1222; border: 1px solid var(--border); border-radius: 10px;
        padding: 5px;
    }
    #selected-agent-display {
        flex: 1; padding: 5px 10px; display: flex; align-items: center;
        color: var(--muted); font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Perplexity Agent Playground</h1>
    <span class="tag">Spaces + Sessions</span>
  </header>
  <main>
    <!-- Chat Panel -->
    <section class="panel">
      <div class="messages" id="messages"></div>
      <form id="chat-form">
        <textarea id="message" placeholder="Ask anything..." required></textarea>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <button type="submit" id="send-btn">Send</button>
          <button type="button" class="secondary" id="reset-btn">Reset</button>
        </div>
      </form>
    </section>

    <!-- Settings Panel -->
    <section class="panel">
      <div class="field">
        <label for="customer-id">Customer / Session ID</label>
        <input id="customer-id" placeholder="e.g. test-user" />
      </div>
      
      <!-- Agent Selection -->
      <div class="field">
          <label>Agent</label>
          <div class="agent-selection">
             <div id="selected-agent-display">None selected</div>
             <input type="hidden" id="agent-id-input" />
             <button type="button" id="open-agent-modal" class="secondary" style="white-space:nowrap; border:none; border-left:1px solid var(--border); border-radius:0 10px 10px 0;">Select Agent</button>
          </div>
      </div>

      <!-- Agent Modal -->
      <dialog id="agent-modal">
        <div class="modal-content">
          <h3 style="margin-top:0">Select an Agent</h3>
          <div id="agent-list-container" class="modal-list">
            <!-- List populated by JS -->
          </div>
          <button id="close-agent-modal" class="secondary" style="width: 100%;">Cancel</button>
        </div>
      </dialog>

      <div class="row">
        <div class="field">
          <label for="account-name">Account Name</label>
          <input id="account-name" placeholder="wrapper account_name (required)" required />
        </div>
        <div class="field">
          <label for="collection-uuid">Custom Space (collection_uuid)</label>
          <input id="collection-uuid" placeholder="optional collection uuid" />
        </div>
      </div>
      
      <div class="row">
        <div class="field">
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="auto">auto</option>
            <option value="writing">writing</option>
            <option value="coding">coding</option>
            <option value="research">research</option>
          </select>
        </div>
        <div class="field">
          <label for="sources">Sources</label>
          <select id="sources">
            <option value="web">web</option>
            <option value="scholar">scholar</option>
            <option value="social">social</option>
            <option value="web,scholar">web,scholar</option>
            <option value="web,social">web,social</option>
            <option value="scholar,social">scholar,social</option>
            <option value="web,scholar,social">web,scholar,social</option>
          </select>
        </div>
      </div>
      
      <div class="field">
        <label for="language">Language</label>
        <input id="language" value="en-US" />
      </div>
      
      <div class="actions">
        <label class="toggle">
          <input type="checkbox" id="parse-actions" />
          Parse actions
        </label>
        <label class="toggle">
          <input type="checkbox" id="answer-only" checked />
          Answer only
        </label>
      </div>
      
      <hr style="border: 0; border-top: 1px solid var(--border); width: 100%; margin: 12px 0;" />

      <div class="actions">
        <div class="pill" id="session-pill">Session: none</div>
        <div class="badge" id="state-pill">State: bot</div>
        <button type="button" class="secondary" id="release-btn" style="font-size:12px; padding:6px 10px;">Release to bot</button>
      </div>
      
      <div class="logs" id="logs"></div>
      
      <hr style="border: 0; border-top: 1px solid var(--border); width: 100%; margin: 12px 0;" />
      
      <div class="row">
        <div class="field">
          <label for="thread-id">Thread ID</label>
          <input id="thread-id" placeholder="Frontend context UUID" />
        </div>
        <div class="field">
          <label for="backend-id">Backend UUID</label>
          <input id="backend-id" placeholder="Optional" />
        </div>
      </div>
      
      <div class="actions">
        <button type="button" class="secondary" id="apply-thread">Set thread</button>
        <button type="button" id="new-thread">New thread</button>
        <button type="button" class="secondary" id="load-threads">Refresh threads</button>
      </div>
      
      <div class="thread-list" id="threads"></div>
    </section>
  </main>

  <script>
    // Wait for DOM to be ready to avoid null reference errors
    window.addEventListener('DOMContentLoaded', () => {
        // Element References
        const els = {
            messages: document.getElementById("messages"),
            form: document.getElementById("chat-form"),
            textarea: document.getElementById("message"),
            resetBtn: document.getElementById("reset-btn"),
            sessionPill: document.getElementById("session-pill"),
            logs: document.getElementById("logs"),
            customerId: document.getElementById("customer-id"),
            accountName: document.getElementById("account-name"),
            collectionUuid: document.getElementById("collection-uuid"),
            mode: document.getElementById("mode"),
            sources: document.getElementById("sources"),
            language: document.getElementById("language"),
            parseActions: document.getElementById("parse-actions"),
            answerOnly: document.getElementById("answer-only"),
            statePill: document.getElementById("state-pill"),
            releaseBtn: document.getElementById("release-btn"),
            threadId: document.getElementById("thread-id"),
            backendId: document.getElementById("backend-id"),
            applyThreadBtn: document.getElementById("apply-thread"),
            newThreadBtn: document.getElementById("new-thread"),
            loadThreadsBtn: document.getElementById("load-threads"),
            threadsContainer: document.getElementById("threads"),
            openModalBtn: document.getElementById("open-agent-modal"),
            closeModalBtn: document.getElementById("close-agent-modal"),
            agentModal: document.getElementById("agent-modal"),
            agentListContainer: document.getElementById("agent-list-container"),
            selectedAgentDisplay: document.getElementById("selected-agent-display"),
            agentIdInput: document.getElementById("agent-id-input")
        };

        // Initialize State
        const savedId = localStorage.getItem("customerId") || `local-${Math.random().toString(16).slice(2,8)}`;
        els.customerId.value = savedId;
        let sessionState = null;

        // --- Helpers ---
        function log(obj) {
            els.logs.textContent = JSON.stringify(obj, null, 2);
        }

        function appendBubble(text, role) {
            const div = document.createElement("div");
            div.className = `bubble ${role}`;
            div.textContent = text;
            els.messages.appendChild(div);
            requestAnimationFrame(() => {
                div.scrollIntoView({ behavior: "smooth", block: "end" });
            });
        }

        function setStatePill(state) {
            const map = {
                bot: { text: "State: bot", cls: "badge" },
                human_handoff: { text: "State: human_handoff", cls: "badge warning" },
                ticket_open: { text: "State: ticket_open", cls: "badge danger" },
            };
            const cfg = map[state] || map.bot;
            els.statePill.className = cfg.cls;
            els.statePill.textContent = cfg.text;
        }

        function setSession(session) {
            sessionState = session;
            if (!session) return;
            els.sessionPill.textContent = `Session: ${session.customerId}`;
            if (session.frontendContextUuid) els.threadId.value = session.frontendContextUuid;
            if (session.backendUuid) els.backendId.value = session.backendUuid;
            if (session.state) setStatePill(session.state);
        }

        // --- Agent Modal Logic ---
        els.openModalBtn.onclick = async () => {
            if (!els.agentModal.showModal) {
                alert("Your browser does not support the <dialog> API.");
                return;
            }
            els.agentModal.showModal();
            els.agentListContainer.innerHTML = '<div style="color: var(--muted); padding: 10px;">Loading agents...</div>';
            
            try {
                const res = await fetch("/api/agents");
                const data = await res.json();
                const list = data.agents || (Array.isArray(data) ? data : []);

                els.agentListContainer.innerHTML = "";
                
                if (list.length === 0) {
                    els.agentListContainer.innerHTML = '<div style="color: var(--muted); padding: 10px;">No agents found. Create one in the Agents tab.</div>';
                    return;
                }

                list.forEach(agent => {
                    const btn = document.createElement("div");
                    btn.className = "agent-btn";
                    const name = agent.name || agent.agent_name || "(Unnamed)";
                    const account = agent.accountName || agent.account_name || "Unknown Account";
                    
                    btn.innerHTML = `<strong>${name}</strong><small>${account}</small>`;
                    btn.onclick = () => {
                        els.agentIdInput.value = agent.id || agent.agent_id;
                        els.selectedAgentDisplay.textContent = name;
                        els.selectedAgentDisplay.style.color = "var(--text)";
                        
                        // Auto-fill fields
                        if (agent.accountName) els.accountName.value = agent.accountName;
                        if (agent.collectionUuid) els.collectionUuid.value = agent.collectionUuid;
                        if (agent.mode) els.mode.value = agent.mode;
                        
                        els.agentModal.close();
                    };
                    els.agentListContainer.appendChild(btn);
                });
            } catch (err) {
                els.agentListContainer.innerHTML = `<div style="color: var(--danger); padding: 10px;">Error loading agents: ${err.message}</div>`;
                console.error(err);
            }
        };

        els.closeModalBtn.onclick = () => els.agentModal.close();

        // --- Chat Logic ---
        async function sendMessage(resetSession = false) {
            const customerId = els.customerId.value.trim();
            if (!customerId) {
                alert("Please enter a Customer ID");
                return;
            }
            localStorage.setItem("customerId", customerId);
            els.sessionPill.textContent = `Session: ${customerId}`;

            const payload = {
                customerId,
                message: els.textarea.value,
                accountName: els.accountName.value || undefined,
                collectionUuid: els.collectionUuid.value || undefined,
                frontendContextUuid: els.threadId.value || undefined,
                backendUuid: els.backendId.value || undefined,
                mode: els.mode.value,
                sources: els.sources.value,
                language: els.language.value,
                resetSession,
                parseActions: els.parseActions.checked,
                answerOnly: els.answerOnly.checked,
                agentId: els.agentIdInput.value || undefined,
            };

            appendBubble(els.textarea.value, "user");
            els.textarea.value = "";

            try {
                const res = await fetch("/api/message", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                const data = await res.json();
                
                if (data.error) {
                    appendBubble(`Error: ${data.error}`, "bot");
                } else {
                    appendBubble(data.reply, "bot");
                }
                
                if (data.session) setSession(data.session);
                if (data.action) {
                    appendBubble(`[action ${data.action.status}] ${JSON.stringify(data.action.action)}`, "bot");
                }
                log(data);
            } catch (err) {
                appendBubble("Network or Server Error", "bot");
                log({ error: err.message });
            }
        }

        els.form.addEventListener("submit", (e) => {
            e.preventDefault();
            if (!els.textarea.value.trim()) return;
            sendMessage(false);
        });

        els.resetBtn.addEventListener("click", () => {
            sendMessage(true);
        });

        // --- Thread Management ---
        async function applyThread() {
            const customerId = els.customerId.value.trim();
            if (!customerId) return;
            
            try {
                const body = {
                    frontendContextUuid: els.threadId.value || null,
                    backendUuid: els.backendId.value || null,
                };
                const res = await fetch(`/api/session/${encodeURIComponent(customerId)}/thread`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                if (data.session) setSession(data.session);
                log(data);
            } catch (err) {
                log({ error: err.message });
            }
        }

        els.applyThreadBtn.onclick = applyThread;
        
        els.newThreadBtn.onclick = () => {
            els.threadId.value = crypto.randomUUID ? crypto.randomUUID() : `thread-${Date.now()}`;
            els.backendId.value = "";
            applyThread();
        };

        els.loadThreadsBtn.onclick = async () => {
            const accountName = els.accountName.value.trim();
            if (!accountName) {
                alert("Enter Account Name first");
                return;
            }
            try {
                const res = await fetch(`/api/threads?accountName=${encodeURIComponent(accountName)}`);
                const data = await res.json();
                const list = data.threads;
                
                els.threadsContainer.innerHTML = "";
                if (!Array.isArray(list) || list.length === 0) {
                    els.threadsContainer.innerHTML = "<small style='color: var(--muted);'>No threads found.</small>";
                    return;
                }
                
                list.forEach((t) => {
                    const card = document.createElement("div");
                    card.className = "thread-card";
                    card.innerHTML = `
                        <h4>${t.title || t.slug || "Untitled"}</h4>
                        <small>${t.frontend_context_uuid || t.id}</small>
                    `;
                    const btn = document.createElement("button");
                    btn.className = "secondary";
                    btn.style.marginTop = "6px";
                    btn.style.fontSize = "11px";
                    btn.textContent = "Load";
                    btn.onclick = () => {
                        const threadId = t.frontend_context_uuid || t.id || t.slug;
                        if (threadId) {
                            els.threadId.value = threadId;
                            els.backendId.value = "";
                            applyThread();
                        }
                    };
                    card.appendChild(btn);
                    els.threadsContainer.appendChild(card);
                });
                log(data);
            } catch (err) {
                log({ error: err.message });
            }
        };

        els.releaseBtn.onclick = async () => {
            const customerId = els.customerId.value.trim();
            if (!customerId) return;
            try {
                const res = await fetch(`/api/session/${encodeURIComponent(customerId)}/state`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ state: "bot" }),
                });
                const data = await res.json();
                if (data.session) setSession(data.session);
                log(data);
                appendBubble("Session state reset to 'bot'", "bot");
            } catch (err) {
                log({ error: err.message });
            }
        };
    });
  </script>
</body>
</html>
